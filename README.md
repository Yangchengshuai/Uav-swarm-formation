# Uav-swarm-formation

# Note!
本次实验采用，三架多旋翼无人机，一台笔记本，实现了编队变换与编队飞行。采用状态机检测键盘指令的方式，控制无人机群实现编队变换和飞行。定位采用的是T265视觉定位，直接输出位置状态信息，此处可使用深度相机D435i进行为VIO（VINS-Fusion）定位，这种方案需要将摄像头中的同类无人机剔除掉，否则影响定位，具体参考ego-swarm。笔记本与无人机间的采用Socket通讯。


# 集群控制技术简介
## 集群控制简介
多机器人群体控制系统一般分为集中式控制结构和分布式控制结构。

集中式控制结构：
一个主控单元，集中掌握了环境中全局信息和所有机器人的信息，进行集中式处理任务与资源分配由主控单元合理分配给每一个机器人，每个机器人只需负责数据的输入和输出，数据的存储和控制处理由主控执行。结构较为简单，系统管理方便。
缺点：（1）计算复杂度增大，反应速度慢，机器人工作效率降低；（2）主控单元出现故障，会导致整个系统陷入瘫痪。
分布式控制结构：
系统不存在控制与被控关系，机器人之间对等，互相信息交互。自主处理实时数据并根据数据规划出一条路径。分布式控制结构可以增加机器人的数目，灵活性较高，适用于动态环境下的工作空间。
缺点：缺乏全局时钟性，机器人之间的协调合作难，获取信息有限难以实现全局最优解。
混合式控制结构：
一个主控单元控制所有机器人，获取机器人当前位置、环境信息、处理数据和制定策略等，为每一个机器人提供最新的全局信息，而每一个机器人采用分布式控制结构，都是一个独立平等的“个体”，与其他机器人实现信息的交流和互换，由主控单元获取的全局信息自主规划路径。
混合式结构中即包含统一全局的中央管理模块，也采用分布式结构中每个成员机器人之间的通信方式。可以看出混合式结构集中了集中式与分布式结构的优点，这样的控制结构避免了成员机器人之间的任务冲突同时又加强了合作。
## 本系统所用方案优劣式介绍
方案介绍：本系统采用混合式集群控制模式，主控机接收处理所有无人机的状态信息，并且发送任务指令给到无人机。无人机分为leader机和follower机，leader机一架， follower机若干架。无人机接收主控机的任务指令，并与leader机通讯，自主处理实时数据并根据数据规划出一条路径。
优点：本机的机载编队算法，具有效率高、节省资源等特点，能够为使用者节省更多的开销，更加快速使单体无人机达到目标点。通讯模块主要采用socket通讯，传输数据为字节级，传输数据可自定义，数据量小，传输数据时间短，性能高。避障模块采用基于球形几何体的编队避障算法，具有高效、低算力的特性，避障算法会对两个无人机施加一个弹簧的力，将两个无人机分离，再结合原始规划路径实现高灵敏避障。
缺点：避障模块只有机间避障，没有对障碍物的路径规划模块，需要后续进行优化。定位模块因为采用的是双目视觉，所以对光照变化和动态场景有一定的敏感性。


# 硬件方案
## 飞行平台介绍
飞行平台的硬件包括一个笔记本（主控机）和若干架无人机，无人机搭载英伟达nx板、t265双目摄像头、PX4飞控、WiFi模块等。
## 无人机集群编队
### 通信硬件系统
   目前机器人常用的通讯架构包括B/S，C/S，MQTT，ROS通讯等。Browser/Server，这个也是我们在日常生活当中经常用到一个服务架构模式，最常见的就是我们在浏览网站的时候，我们以Browser的身份向Server服务器发起访问，从而看到我们想看到的内容。而Client/Server中Socket套接字是C/S架构的实现方式，主要是TCP/UDP通讯，socket通信机制，可以应用于计算机不同进程之间通信，包括同一台计算机和网络中不同计算机之间的进程之间通信，结果就是支持分布在网络中的各个服务端/客户端的通信。MQTT（消息队列遥测传输协议），是一种基于发布/订阅模式的”轻量级”通讯协议，该协议构建于TCP/IP协 议上。ROS通讯包含的话题、服务、动作机制三种通讯方式。
本系统通讯采用WiFi无线通讯，主控机与无人机需要安装WiFi模块，在同一WiFi路由下进行socket字节流通讯和ROS话题、服务通讯。另外可以扩展添加UWB机间测距信号，用相对距离来保持编队队形。
### 软件系统结构
软件运行流程：
1.无人机开启t265定位模块
2.无人机开启mavros通信模块，进行PX4飞控和ROS机的通信
3.无人机开启多进程，发送自身位置坐标和等待接受主控机的指令信息。
4.主控机开启键盘控制程序

使用步骤：
0.设置IP地址，已便主控机与无人机进行通讯
1.将无人机按照程序设定摆好位置，开机
2.在无人机上运行start.sh文件，启动通讯模块和定位模块
3.将无人机调成position模式
4.主控机上运行commander.py文件，开启键盘控制

## 集群编队方案
定位：
T265是一个尺寸小、功耗低的完整的嵌入式SLAM解决方案，它将视觉特征与惯性测量单元 (IMU) 结合起来，使用视觉惯性里程计来计算其在3D空间中的方向和位置，亦即六自由度。T265直接输出位置信息，定位精度答厘米级。
避障：
在高速运动过程当中无人机可能会和其他无人机路线相交叉，一些无人机采取将本机的路线广播出去，其它无人机再针对每一架无人机做出机间避障路径，这是效率低的，并且会增加无人机算力消耗和增加编队网络中的数据传输量，导致延迟高，控制不灵敏等特点。机载算法搭载基于球形几何体的编队避障算法，每个无人机只需将其本机实时目标位置广播出去，其他无人机进入主体无人机球形几何体就会触发避障算法，避障算法会对两个无人机施加一个弹簧的力，将两个无人机分离，再结合原始规划路径实现高灵敏避障算法。

通讯：
主控机与无人机之间用socket创建UDP连接,无人机将自身位置数据利用UDP点对点的传给主控机进行处理，主控机将任务指令采用广播的方式传给各无人机。无人机机间通讯采用ROS的架构，follower机订阅leader机的位置信息，无人机根据接受的任务指令和leader位置信息，进行相对于leader机坐标系下的编队任务飞行。


# 仿真环境方案
参考XTDrone仿真环境搭建


# 系统使用说明及功能描述
功能描述： 可实现编队变换、直线编队飞行、三角编队飞行、机间避障四大功能。

使用说明：
1.无人机起飞前的摆放位置是在程序中预先设定好的，可根据自己需要改动
2.无人机需要保证在position模式下，才可以运行自动起飞程序，如果无法进入position模式，可以查看t265定位是否成功。
3.无人机起飞前务必确保定位没有飘，可通过输出定位话题信息查看定位情况。
4.程序中可调节Kp大小来调整无人机反应速度，后面可以将P调节优化为PD调节，或者如下图所示，更改位置误差与期望速度的函数关系为APM开方控制+限幅度，无人机控制会更加顺滑。
5.无人机在自动启飞模式下无法切换为手动控制，如果想将无人机切换成手动控制需要将无人机切换到其他模式下方可手动控制飞行或降落。



# 直线编队飞行
![img](https://github.com/publicboyfriend/Uav-swarm-formation/blob/main/image/output.gif)


# 三角编队飞行
![img](https://github.com/publicboyfriend/Uav-swarm-formation/blob/main/image/output1.gif)
![img](https://github.com/publicboyfriend/Uav-swarm-formation/blob/main/image/output2.gif)

# 集群编队飞行视频
链接：https://www.bilibili.com/video/BV1jd4y1y7d8/?spm_id_from=333.337.search-card.all.click&vd_source=8c9644ebf9f2a4932abb6080dd498157
